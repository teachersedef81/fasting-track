<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Keto & AralÄ±klÄ± OruÃ§ Takip UygulamasÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-indigo-600">Keto & AralÄ±klÄ± OruÃ§ TakipÃ§isi</h1>
            <p class="text-lg text-slate-600 mt-2">SaÄŸlÄ±klÄ± yaÅŸam yolculuÄŸunuzda size yardÄ±mcÄ± olmak iÃ§in tasarlandÄ±.</p>
        </header>

        <nav class="mb-8 bg-white shadow-md rounded-lg p-2 flex justify-center space-x-2">
            <button id="navDailyEntry" class="nav-link px-4 py-2 rounded-md font-medium text-slate-700">ğŸ“ GÃ¼nlÃ¼k KayÄ±t</button>
            <button id="navPastEntries" class="nav-link px-4 py-2 rounded-md font-medium text-slate-700">ğŸ—“ï¸ GeÃ§miÅŸ KayÄ±tlar</button>
            <button id="navProgressCharts" class="nav-link px-4 py-2 rounded-md font-medium text-slate-700">ğŸ“Š Ä°lerleme Grafikleri</button>
        </nav>

        <main id="appContent">
            </main>

        <footer class="mt-12 text-center text-sm text-slate-500">
            <p>&copy; <span id="currentYear"></span> Ä°nteraktif Takip UygulamasÄ±. TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>
            <p class="mt-1">âœ¨ <span id="motivationQuote"></span> âœ¨</p>
        </footer>
    </div>

    
<script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth-compat.js"></script>
    <script>
    // ---- JAVASCRIPT KODLARI ----

    // 1. FIREBASE CONFIG OBJESÄ° (bb.png ekran gÃ¶rÃ¼ntÃ¼nÃ¼zdeki deÄŸerlerle aynÄ± olmalÄ±)
    const firebaseConfig = {
      apiKey: "AIzaSyCshw-M2mDwUg_Zfkd-PRyPas5owutWbJo", // bb.png ekran gÃ¶rÃ¼ntÃ¼nÃ¼zdeki deÄŸer
      authDomain: "fasting-track.firebaseapp.com",
      projectId: "fasting-track",
      storageBucket: "fasting-track.firebasestorage.app",
      messagingSenderId: "1030936924515",
      appId: "1:1030936924515:web:89868eb46480f7960bc356",
      measurementId: "G-31GBVXS317"
    };

    // 2. FIREBASE'Ä° BAÅLATIN:
    firebase.initializeApp(firebaseConfig);

    // 3. KULLANACAÄINIZ SERVÄ°SLERE REFERANSLAR OLUÅTURUN:
    const db = firebase.firestore(); // Firestore veritabanÄ± iÃ§in
    const auth = firebase.auth();   // Firebase Authentication iÃ§in

        // --- APPLICATION STATE AND DATA ---
        let dailyEntries = []; // Veriler Firestore'dan geleceÄŸi iÃ§in baÅŸlangÄ±Ã§ta boÅŸ dizi
        let currentView = 'DailyEntry';
        let selectedDate = new Date().toISOString().split('T')[0]; 
        let charts = {}; 

        const motivationQuotes = [
            "BugÃ¼n attÄ±ÄŸÄ±n kÃ¼Ã§Ã¼k adÄ±mlar, yarÄ±nki bÃ¼yÃ¼k farkÄ± yaratÄ±r.",
            "SaÄŸlÄ±ÄŸÄ±na yaptÄ±ÄŸÄ±n yatÄ±rÄ±m, en deÄŸerli kazancÄ±ndÄ±r.",
            "Unutma, en iyi proje sensin!",
            "Her saÄŸlÄ±klÄ± seÃ§im, hedefine bir adÄ±m daha yaklaÅŸmaktÄ±r.",
            "VazgeÃ§mek istediÄŸinde, neden baÅŸladÄ±ÄŸÄ±nÄ± hatÄ±rla."
        ];

        // --- DOM ELEMENTS ---
        const appContent = document.getElementById('appContent');
        const navDailyEntry = document.getElementById('navDailyEntry');
        const navPastEntries = document.getElementById('navPastEntries');
        const navProgressCharts = document.getElementById('navProgressCharts');
        const motivationQuoteEl = document.getElementById('motivationQuote');
        // currentYear initApp iÃ§inde ayarlanacak

        // --- UTILITY FUNCTIONS ---
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            return new Date(dateString + 'T00:00:00').toLocaleDateString('tr-TR', options);
        }

        function calculateDuration(startTime, endTime) {
            if (!startTime || !endTime) return { hours: 0, minutes: 0 };
            const start = new Date(`1970-01-01T${startTime}:00`);
            let end = new Date(`1970-01-01T${endTime}:00`);
            if (end < start) { 
                end.setDate(end.getDate() + 1);
            }
            const diffMs = end - start;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            return { hours: diffHours, minutes: diffMinutes };
        }

        // --- DATA HANDLING (Firestore iÃ§in gÃ¼ncellenecek bÃ¶lÃ¼mler) ---
        function saveEntries(entryDataToSave) { // Fonksiyon Firestore'a tek bir kayÄ±t gÃ¶nderecek ÅŸekilde deÄŸiÅŸtirilebilir
            // localStorage.setItem('ketoTrackerEntries_v1', JSON.stringify(dailyEntries)); // ESKÄ° KOD - YORUM SATIRI
            console.log("saveEntries fonksiyonu Firestore'a veri kaydetmek iÃ§in gÃ¼ncellenecek.", entryDataToSave);
            // Ã–RNEK Firestore kaydÄ± (sonra detaylandÄ±rÄ±lacak):
            // if (auth.currentUser && entryDataToSave) {
            //   return db.collection('users').doc(auth.currentUser.uid).collection('entries').doc(entryDataToSave.date).set(entryDataToSave);
            // } else {
            //   console.error("KullanÄ±cÄ± giriÅŸi yapÄ±lmamÄ±ÅŸ veya kaydedilecek veri yok!");
            //   return Promise.reject("KullanÄ±cÄ± giriÅŸi yapÄ±lmamÄ±ÅŸ veya kaydedilecek veri yok!");
            // }
        }

        function getEntryForDate(date) {
            // Bu fonksiyon, dailyEntries dizisi Firestore'dan doldurulduktan sonra Ã§alÄ±ÅŸacak.
            // Ya da doÄŸrudan Firestore'dan belirli bir tarih iÃ§in veri Ã§ekebilir.
            // Åimdilik client-side dailyEntries dizisine bakÄ±yor.
            return dailyEntries.find(entry => entry.date === date) || createNewEntry(date);
        }
        
        function createNewEntry(date) {
            return {
                date: date,
                hedefOruc: 16,
                orucBaslangic: '',
                orucBitis: '',
                toplamOrucSaat: 0,
                toplamOrucDakika: 0,
                carbAzaltildi: false,
                ketoyaGecildi: false,
                ketozisNotlar: '',
                yenilenler: [{ protein: '', yag: '', sebze: '', karbonhidrat: '', saat: '' }],
                suLitre: '',
                tuzAldim: false, tuzNot: '',
                magnezyumAldim: false, magnezyumNot: '',
                potasyumAldim: false, potasyumNot: '',
                ruhHali: 3, 
                enerjiSeviyesi: 3, 
                kendimiHissettim: '',
                notlar: ''
            };
        }

        function updateOrAddEntry(entryData) {
            // Bu fonksiyon, veriyi hem client-side `dailyEntries` dizisine ekler/gÃ¼nceller (arayÃ¼zÃ¼n hÄ±zlÄ± tepkisi iÃ§in)
            // hem de Firestore'a kaydeder.
            const index = dailyEntries.findIndex(e => e.date === entryData.date);
            if (index > -1) {
                dailyEntries[index] = entryData;
            } else {
                dailyEntries.push(entryData);
            }
            dailyEntries.sort((a, b) => new Date(b.date) - new Date(a.date)); 
            
            saveEntries(entryData) // Firestore'a kaydetmek iÃ§in saveEntries'i Ã§aÄŸÄ±r.
                .then(() => {
                    console.log("Veri Firestore'a baÅŸarÄ±yla kaydedildi (veya gÃ¼ncellendi).");
                    alert('KayÄ±t baÅŸarÄ±yla gÃ¼ncellendi!'); // KullanÄ±cÄ±ya Firestore sonrasÄ± bilgi verilebilir.
                })
                .catch(error => {
                    console.error("Firestore'a kaydederken hata oluÅŸtu: ", error);
                    alert('KayÄ±t gÃ¼ncellenirken bir sorun oluÅŸtu. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
                });
             // renderDailyEntry(); // Bu, handleFormSubmit iÃ§inde zaten Ã§aÄŸrÄ±lÄ±yor. Tekrar Ã§aÄŸÄ±rmaya gerek yok.
        }

        // --- RENDERING VIEWS (FonksiyonlarÄ±n iÃ§indeki HTML oluÅŸturma kÄ±sÄ±mlarÄ± aynÄ± kalÄ±r) ---
        function renderDailyEntry() {
            currentView = 'DailyEntry';
            setActiveNav(navDailyEntry);
            const entry = getEntryForDate(selectedDate);

            let mealsHtml = entry.yenilenler.map((meal, index) => `
                <div class="border border-slate-200 p-3 rounded-md mb-3 meal-entry">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-md font-semibold text-indigo-600">Ã–ÄŸÃ¼n ${index + 1}</h4>
                        ${entry.yenilenler.length > 1 ? `<button type="button" class="text-red-500 hover:text-red-700 remove-meal-btn" data-index="${index}">âœ– KaldÄ±r</button>` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Saat:</label><input type="time" class="form-input meal-saat" value="${meal.saat || ''}"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Protein:</label><input type="text" class="form-input meal-protein" placeholder="Ã–rn: Tavuk gÃ¶ÄŸsÃ¼, yumurta" value="${meal.protein || ''}"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">YaÄŸ:</label><input type="text" class="form-input meal-yag" placeholder="Ã–rn: ZeytinyaÄŸÄ±, avokado" value="${meal.yag || ''}"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Sebze:</label><input type="text" class="form-input meal-sebze" placeholder="Ã–rn: Brokoli, Ä±spanak" value="${meal.sebze || ''}"></div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700 mb-1">Karbonhidrat (Kaynak ve Miktar):</label><input type="text" class="form-input meal-karbonhidrat" placeholder="Ã–rn: 1/4 avokado, 5g" value="${meal.karbonhidrat || ''}"></div>
                    </div>
                </div>
            `).join('');

            appContent.innerHTML = `
                <div class="bg-white p-6 shadow-xl rounded-lg">
                    <div class="mb-6 pb-4 border-b border-slate-200">
                        <h2 class="text-2xl font-semibold text-indigo-700 mb-1">GÃ¼nlÃ¼k KayÄ±t GiriÅŸi</h2>
                        <p class="text-sm text-slate-500">Bu bÃ¶lÃ¼mde, seÃ§tiÄŸiniz gÃ¼ne ait beslenme, oruÃ§ ve genel durum bilgilerinizi girebilirsiniz. GirdiÄŸiniz veriler, ilerlemenizi takip etmenize yardÄ±mcÄ± olacaktÄ±r.</p>
                    </div>
                    <form id="dailyEntryForm">
                        <div class="mb-4">
                            <label for="entryDate" class="block text-sm font-medium text-slate-700 mb-1">Tarih SeÃ§in:</label>
                            <input type="date" id="entryDate" class="form-input w-auto" value="${selectedDate}">
                        </div>
                        <h3 class="text-xl font-semibold text-indigo-600 border-b border-indigo-200 pb-2 mb-4 mt-6">1. GÃ¼nlÃ¼k OruÃ§ SÃ¼resi</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="hedefOruc" class="block text-sm font-medium text-slate-700 mb-1">Hedef OruÃ§ SÃ¼resi:</label>
                                <select id="hedefOruc" class="form-select">
                                    <option value="16" ${entry.hedefOruc == 16 ? 'selected' : ''}>16 Saat</option>
                                    <option value="18" ${entry.hedefOruc == 18 ? 'selected' : ''}>18 Saat</option>
                                    <option value="20" ${entry.hedefOruc == 20 ? 'selected' : ''}>20 Saat</option>
                                    <option value="custom" ${![16,18,20].includes(parseInt(entry.hedefOruc)) && entry.hedefOruc ? 'selected' : ''}>DiÄŸer</option>
                                </select>
                                <input type="number" id="hedefOrucCustom" class="form-input mt-1 ${![16,18,20].includes(parseInt(entry.hedefOruc)) && entry.hedefOruc ? '' : 'hidden'}" placeholder="Saat girin" value="${entry.hedefOruc && ![16,18,20].includes(parseInt(entry.hedefOruc)) ? entry.hedefOruc : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">GerÃ§ekleÅŸen OruÃ§:</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label for="orucBaslangic" class="text-xs text-slate-600">BaÅŸlangÄ±Ã§:</label><input type="time" id="orucBaslangic" class="form-input" value="${entry.orucBaslangic || ''}"></div>
                                    <div><label for="orucBitis" class="text-xs text-slate-600">BitiÅŸ:</label><input type="time" id="orucBitis" class="form-input" value="${entry.orucBitis || ''}"></div>
                                </div>
                                <p class="text-sm text-slate-600 mt-1">Toplam: <span id="toplamOrucSuresi">${entry.toplamOrucSaat || 0} saat ${entry.toplamOrucDakika || 0} dakika</span></p>
                            </div>
                        </div>

                        <h3 class="text-xl font-semibold text-indigo-600 border-b border-indigo-200 pb-2 mb-4 mt-6">2. Karbonhidrat Durumu</h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="carbAzaltildi" class="form-checkbox h-5 w-5 text-indigo-600 rounded" ${entry.carbAzaltildi ? 'checked' : ''}>
                                <span class="ml-2 text-slate-700">Karbonhidrat AlÄ±mÄ± AzaltÄ±ldÄ±</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="ketoyaGecildi" class="form-checkbox h-5 w-5 text-indigo-600 rounded" ${entry.ketoyaGecildi ? 'checked' : ''}>
                                <span class="ml-2 text-slate-700">Ketoya GeÃ§ildi / Ketozis Belirtileri Var</span>
                            </label>
                            <div>
                                <label for="ketozisNotlar" class="block text-sm font-medium text-slate-700 mb-1">Ketozis Belirtileri/NotlarÄ±:</label>
                                <input type="text" id="ketozisNotlar" class="form-input" placeholder="Ã–rn: Enerji artÄ±ÅŸÄ±, aÄŸÄ±z kuruluÄŸu" value="${entry.ketozisNotlar || ''}">
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-semibold text-indigo-600 border-b border-indigo-200 pb-2 mb-4 mt-6">3. Yenilenler</h3>
                        <div id="mealsContainer">${mealsHtml}</div>
                        <button type="button" id="addMealBtn" class="btn btn-secondary text-sm mt-2">ğŸ³ Ã–ÄŸÃ¼n Ekle</button>

                        <h3 class="text-xl font-semibold text-indigo-600 border-b border-indigo-200 pb-2 mb-4 mt-6">4. Su ve Elektrolit Takibi</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="suLitre" class="block text-sm font-medium text-slate-700 mb-1">Su TÃ¼ketimi (Litre):</label>
                                <input type="number" id="suLitre" class="form-input" step="0.1" placeholder="Ã–rn: 2.5" value="${entry.suLitre || ''}">
                            </div>
                            <div class="space-y-2">
                                <p class="text-sm font-medium text-slate-700">Elektrolitler:</p>
                                <label class="flex items-center"><input type="checkbox" id="tuzAldim" class="form-checkbox h-5 w-5 text-indigo-600 rounded" ${entry.tuzAldim ? 'checked' : ''}><span class="ml-2 text-slate-700">Tuz (Sodyum)</span></label>
                                <input type="text" id="tuzNot" class="form-input text-sm ${entry.tuzAldim ? '' : 'hidden'}" placeholder="Kaynak/Miktar (Ã–rn: Himalaya tuzu, 1 Ã§ay kaÅŸÄ±ÄŸÄ±)" value="${entry.tuzNot || ''}">
                                
                                <label class="flex items-center mt-1"><input type="checkbox" id="magnezyumAldim" class="form-checkbox h-5 w-5 text-indigo-600 rounded" ${entry.magnezyumAldim ? 'checked' : ''}><span class="ml-2 text-slate-700">Magnezyum</span></label>
                                <input type="text" id="magnezyumNot" class="form-input text-sm ${entry.magnezyumAldim ? '' : 'hidden'}" placeholder="Kaynak/Miktar (Ã–rn: Sitrat, 200mg)" value="${entry.magnezyumNot || ''}">

                                <label class="flex items-center mt-1"><input type="checkbox" id="potasyumAldim" class="form-checkbox h-5 w-5 text-indigo-600 rounded" ${entry.potasyumAldim ? 'checked' : ''}><span class="ml-2 text-slate-700">Potasyum</span></label>
                                <input type="text" id="potasyumNot" class="form-input text-sm ${entry.potasyumAldim ? '' : 'hidden'}" placeholder="Kaynak/Miktar (Ã–rn: Avokado, takviye)" value="${entry.potasyumNot || ''}">
                            </div>
                        </div>

                        <h3 class="text-xl font-semibold text-indigo-600 border-b border-indigo-200 pb-2 mb-4 mt-6">5. GÃ¼nlÃ¼k Ruh Hali & Enerji Durumu</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="ruhHali" class="block text-sm font-medium text-slate-700 mb-1">Ruh Halim (1 DÃ¼ÅŸÃ¼k - 5 YÃ¼ksek): <span id="ruhHaliValue">${entry.ruhHali}</span></label>
                                <input type="range" id="ruhHali" min="1" max="5" step="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" value="${entry.ruhHali}">
                            </div>
                            <div>
                                <label for="enerjiSeviyesi" class="block text-sm font-medium text-slate-700 mb-1">Enerji Seviyem (1 DÃ¼ÅŸÃ¼k - 5 YÃ¼ksek): <span id="enerjiSeviyesiValue">${entry.enerjiSeviyesi}</span></label>
                                <input type="range" id="enerjiSeviyesi" min="1" max="5" step="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" value="${entry.enerjiSeviyesi}">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="kendimiHissettim" class="block text-sm font-medium text-slate-700 mb-1">Kendimi NasÄ±l Hissettim (KÄ±saca):</label>
                            <textarea id="kendimiHissettim" rows="2" class="form-textarea" placeholder="BugÃ¼nkÃ¼ genel hisleriniz...">${entry.kendimiHissettim || ''}</textarea>
                        </div>

                        <h3 class="text-xl font-semibold text-indigo-600 border-b border-indigo-200 pb-2 mb-4 mt-6">6. Notlar</h3>
                        <div>
                            <label for="notlar" class="block text-sm font-medium text-slate-700 mb-1">Ek NotlarÄ±nÄ±z:</label>
                            <textarea id="notlar" rows="3" class="form-textarea" placeholder="BaÅŸ aÄŸrÄ±sÄ±, uyku kalitesi, egzersiz performansÄ± vb.">${entry.notlar || ''}</textarea>
                        </div>

                        <div class="mt-8 text-center">
                            <button type="submit" class="btn btn-primary">ğŸ’¾ KaydÄ± GÃ¼ncelle</button>
                        </div>
                    </form>
                </div>
            `;
            addDailyEntryListeners();
            updateOrucDisplay(); 
        }

        function addDailyEntryListeners() {
            // Dinamik olarak oluÅŸturulan form iÃ§in event listener'larÄ± burada yeniden eklememiz GEREKEBÄ°LÄ°R.
            // Ancak renderDailyEntry her Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda iÃ§indeki form ve elementler yeniden oluÅŸtuÄŸu iÃ§in,
            // listener'larÄ± renderDailyEntry Ã§aÄŸrÄ±sÄ±ndan sonra eklemek daha gÃ¼venli olabilir.
            // Åimdilik, form submit ve date change dÄ±ÅŸÄ±ndakiler renderDailyEntry iÃ§inde olduÄŸu iÃ§in sorun olmayabilir.
            // Test edip gÃ¶receÄŸiz.
            const entryDateInput = document.getElementById('entryDate');
            if (entryDateInput) {
                entryDateInput.addEventListener('change', (e) => {
                    selectedDate = e.target.value;
                    renderDailyEntry(); 
                });
            }

            const form = document.getElementById('dailyEntryForm');
            if (form) {
                form.addEventListener('submit', handleFormSubmit);
            }

            const orucBaslangicEl = document.getElementById('orucBaslangic');
            const orucBitisEl = document.getElementById('orucBitis');
            if(orucBaslangicEl) orucBaslangicEl.addEventListener('change', updateOrucDisplay);
            if(orucBitisEl) orucBitisEl.addEventListener('change', updateOrucDisplay);
            
            const hedefOrucSelect = document.getElementById('hedefOruc');
            const hedefOrucCustomInput = document.getElementById('hedefOrucCustom');
            if(hedefOrucSelect) {
                hedefOrucSelect.addEventListener('change', () => {
                    hedefOrucCustomInput.classList.toggle('hidden', hedefOrucSelect.value !== 'custom');
                    if (hedefOrucSelect.value !== 'custom') hedefOrucCustomInput.value = '';
                });
            }

            ['tuz', 'magnezyum', 'potasyum'].forEach(el => {
                const checkbox = document.getElementById(`${el}Aldim`);
                const notInput = document.getElementById(`${el}Not`);
                if(checkbox && notInput) {
                    checkbox.addEventListener('change', (e) => {
                        notInput.classList.toggle('hidden', !e.target.checked);
                        if(!e.target.checked) notInput.value = '';
                    });
                }
            });
            
            const ruhHaliInput = document.getElementById('ruhHali');
            const ruhHaliValueEl = document.getElementById('ruhHaliValue');
            if(ruhHaliInput && ruhHaliValueEl) {
                ruhHaliInput.addEventListener('input', (e) => {
                    ruhHaliValueEl.textContent = e.target.value;
                });
            }

            const enerjiSeviyesiInput = document.getElementById('enerjiSeviyesi');
            const enerjiSeviyesiValueEl = document.getElementById('enerjiSeviyesiValue');
            if(enerjiSeviyesiInput && enerjiSeviyesiValueEl) {
                enerjiSeviyesiInput.addEventListener('input', (e) => {
                    enerjiSeviyesiValueEl.textContent = e.target.value;
                });
            }

            const addMealBtn = document.getElementById('addMealBtn');
            if(addMealBtn) addMealBtn.addEventListener('click', addMeal);

            const mealsContainer = document.getElementById('mealsContainer');
            if(mealsContainer) {
                mealsContainer.addEventListener('click', function(e) {
                    if (e.target.classList.contains('remove-meal-btn')) {
                        removeMeal(parseInt(e.target.dataset.index));
                    }
                });
            }
        }
        
        function updateOrucDisplay() {
            const baslangic = document.getElementById('orucBaslangic')?.value; // Optional chaining
            const bitis = document.getElementById('orucBitis')?.value;       // Optional chaining
            const toplamOrucSuresiEl = document.getElementById('toplamOrucSuresi');
            if(baslangic && bitis && toplamOrucSuresiEl){
                const duration = calculateDuration(baslangic, bitis);
                toplamOrucSuresiEl.textContent = `${duration.hours} saat ${duration.minutes} dakika`;
            } else if (toplamOrucSuresiEl) {
                const entry = getEntryForDate(selectedDate); // EÄŸer inputlar boÅŸsa mevcut entry'den almayÄ± dene
                toplamOrucSuresiEl.textContent = `${entry.toplamOrucSaat || 0} saat ${entry.toplamOrucDakika || 0} dakika`;
            }
        }

        function addMeal() {
            const entry = getEntryForDate(selectedDate);
            entry.yenilenler.push({ protein: '', yag: '', sebze: '', karbonhidrat: '', saat: '' });
            const currentScrollPos = window.scrollY;
            renderDailyEntry();
            window.scrollTo(0, currentScrollPos); 
        }

        function removeMeal(index) {
            const entry = getEntryForDate(selectedDate);
            if (entry.yenilenler.length > 1) {
                entry.yenilenler.splice(index, 1);
                const currentScrollPos = window.scrollY;
                renderDailyEntry();
                window.scrollTo(0, currentScrollPos);
            }
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            
            const hedefOrucSelected = document.getElementById('hedefOruc').value;
            const hedefOrucValue = hedefOrucSelected === 'custom' ? document.getElementById('hedefOrucCustom').value : hedefOrucSelected;

            const orucBaslangic = document.getElementById('orucBaslangic').value;
            const orucBitis = document.getElementById('orucBitis').value;
            const orucDuration = calculateDuration(orucBaslangic, orucBitis);

            const mealsData = [];
            document.querySelectorAll('#mealsContainer .meal-entry').forEach(mealEl => {
                mealsData.push({
                    saat: mealEl.querySelector('.meal-saat').value,
                    protein: mealEl.querySelector('.meal-protein').value,
                    yag: mealEl.querySelector('.meal-yag').value,
                    sebze: mealEl.querySelector('.meal-sebze').value,
                    karbonhidrat: mealEl.querySelector('.meal-karbonhidrat').value,
                });
            });

            const entryData = {
                date: selectedDate,
                hedefOruc: hedefOrucValue,
                orucBaslangic: orucBaslangic,
                orucBitis: orucBitis,
                toplamOrucSaat: orucDuration.hours,
                toplamOrucDakika: orucDuration.minutes,
                carbAzaltildi: document.getElementById('carbAzaltildi').checked,
                ketoyaGecildi: document.getElementById('ketoyaGecildi').checked,
                ketozisNotlar: document.getElementById('ketozisNotlar').value,
                yenilenler: mealsData,
                suLitre: document.getElementById('suLitre').value,
                tuzAldim: document.getElementById('tuzAldim').checked,
                tuzNot: document.getElementById('tuzNot').value,
                magnezyumAldim: document.getElementById('magnezyumAldim').checked,
                magnezyumNot: document.getElementById('magnezyumNot').value,
                potasyumAldim: document.getElementById('potasyumAldim').checked,
                potasyumNot: document.getElementById('potasyumNot').value,
                ruhHali: document.getElementById('ruhHali').value,
                enerjiSeviyesi: document.getElementById('enerjiSeviyesi').value,
                kendimiHissettim: document.getElementById('kendimiHissettim').value,
                notlar: document.getElementById('notlar').value
            };
            updateOrAddEntry(entryData); // Bu artÄ±k Firestore'a yazmayÄ± deneyecek (veya console'a log atacak)
            // alert('KayÄ±t baÅŸarÄ±yla gÃ¼ncellendi!'); // Bu satÄ±r updateOrAddEntry iÃ§ine taÅŸÄ±ndÄ± (Firestore sonrasÄ± iÃ§in)
            renderDailyEntry(); 
        }

        function renderPastEntries() {
            currentView = 'PastEntries';
            setActiveNav(navPastEntries);
            // dailyEntries Firestore'dan yÃ¼klendikten sonra bu fonksiyon anlamlÄ± olacak.
            // Åimdilik, eÄŸer dailyEntries boÅŸsa mesaj gÃ¶sterecek.
            if (dailyEntries.length === 0) {
                appContent.innerHTML = `
                    <div class="bg-white p-6 shadow-xl rounded-lg text-center">
                        <h2 class="text-2xl font-semibold text-indigo-700 mb-3">GeÃ§miÅŸ KayÄ±tlar</h2>
                        <p class="text-slate-600 mb-2">HenÃ¼z Firebase'den yÃ¼klenmiÅŸ veya kaydedilmiÅŸ bir gÃ¼nÃ¼nÃ¼z bulunmuyor.</p>
                        <p class="text-sm text-slate-500">"GÃ¼nlÃ¼k KayÄ±t" bÃ¶lÃ¼mÃ¼nden veri giriÅŸi yapmayÄ± deneyebilirsiniz.</p>
                    </div>`;
                return;
            }

            const entriesHtml = dailyEntries.map(entry => `
                <div class="bg-slate-100 p-4 rounded-lg shadow hover:shadow-md transition-shadow cursor-pointer past-entry-item" data-date="${entry.date}">
                    <h4 class="font-semibold text-indigo-600">${formatDate(entry.date)}</h4>
                    <p class="text-sm text-slate-500">OruÃ§: ${entry.toplamOrucSaat || 0}s ${entry.toplamOrucDakika || 0}d | Ruh Hali: ${entry.ruhHali || 'N/A'} | Enerji: ${entry.enerjiSeviyesi || 'N/A'}</p>
                </div>
            `).join('');

            appContent.innerHTML = `
                <div class="bg-white p-6 shadow-xl rounded-lg">
                    <div class="mb-6 pb-4 border-b border-slate-200">
                        <h2 class="text-2xl font-semibold text-indigo-700 mb-1">GeÃ§miÅŸ KayÄ±tlar</h2>
                        <p class="text-sm text-slate-500">Daha Ã¶nceki gÃ¼nlere ait kayÄ±tlarÄ±nÄ±zÄ± burada gÃ¶rebilirsiniz. Bir kaydÄ± gÃ¶rÃ¼ntÃ¼lemek veya dÃ¼zenlemek iÃ§in Ã¼zerine tÄ±klayÄ±n.</p>
                    </div>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto past-entries-list pr-2">
                        ${entriesHtml}
                    </div>
                </div>
            `;
            
            document.querySelectorAll('.past-entry-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    selectedDate = e.currentTarget.dataset.date;
                    renderDailyEntry(); 
                });
            });
        }

        function renderProgressCharts() {
            currentView = 'ProgressCharts';
            setActiveNav(navProgressCharts);
            // dailyEntries Firestore'dan yÃ¼klendikten sonra bu fonksiyon anlamlÄ± olacak.
            if (dailyEntries.length < 2) { 
                 appContent.innerHTML = `
                    <div class="bg-white p-6 shadow-xl rounded-lg text-center">
                        <h2 class="text-2xl font-semibold text-indigo-700 mb-3">Ä°lerleme Grafikleri</h2>
                        <p class="text-slate-600 mb-2">Grafikleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in en az 2 gÃ¼nlÃ¼k Firebase verisi gerekmektedir.</p>
                        <p class="text-sm text-slate-500">"GÃ¼nlÃ¼k KayÄ±t" bÃ¶lÃ¼mÃ¼nden veri giriÅŸi yapmaya devam edin.</p>
                    </div>`;
                return;
            }
            
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            appContent.innerHTML = `
                <div class="bg-white p-6 shadow-xl rounded-lg">
                    <div class="mb-6 pb-4 border-b border-slate-200">
                        <h2 class="text-2xl font-semibold text-indigo-700 mb-1">Ä°lerleme Grafikleri</h2>
                        <p class="text-sm text-slate-500">Zaman iÃ§indeki ilerlemenizi gÃ¶steren grafikler aÅŸaÄŸÄ±dadÄ±r. Bu grafikler, oruÃ§ sÃ¼relerinizi, ruh halinizi ve enerji seviyelerinizi gÃ¶rselleÅŸtirmenize yardÄ±mcÄ± olur.</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold text-indigo-600 mb-2 text-center">OruÃ§ SÃ¼resi (Saat)</h3>
                            <div class="chart-container"><canvas id="fastingHoursChart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-indigo-600 mb-2 text-center">Ruh Hali (1-5)</h3>
                            <div class="chart-container"><canvas id="moodChart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-indigo-600 mb-2 text-center">Enerji Seviyesi (1-5)</h3>
                            <div class="chart-container"><canvas id="energyChart"></canvas></div>
                        </div>
                         ${dailyEntries.some(e => e.suLitre) ? `
                        <div>
                            <h3 class="text-lg font-semibold text-indigo-600 mb-2 text-center">Su TÃ¼ketimi (Litre)</h3>
                            <div class="chart-container"><canvas id="waterIntakeChart"></canvas></div>
                        </div>` : ''}
                    </div>
                </div>
            `;

            const sortedEntries = [...dailyEntries].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedEntries.map(e => new Date(e.date).toLocaleDateString('tr-TR', { day:'2-digit', month:'short'}));
            
            const fastingData = sortedEntries.map(e => parseFloat(e.toplamOrucSaat || 0) + parseFloat(e.toplamOrucDakika || 0)/60);
            createChart('fastingHoursChart', 'line', labels, fastingData, 'OruÃ§ SÃ¼resi (Saat)', 'rgba(79, 70, 229, 0.7)', 'rgba(79, 70, 229, 1)');

            const moodData = sortedEntries.map(e => parseInt(e.ruhHali));
            createChart('moodChart', 'line', labels, moodData, 'Ruh Hali', 'rgba(16, 185, 129, 0.7)', 'rgba(16, 185, 129, 1)'); 

            const energyData = sortedEntries.map(e => parseInt(e.enerjiSeviyesi));
            createChart('energyChart', 'line', labels, energyData, 'Enerji Seviyesi', 'rgba(217, 119, 6, 0.7)', 'rgba(217, 119, 6, 1)'); 

            if (dailyEntries.some(e => e.suLitre)) {
                const waterData = sortedEntries.map(e => parseFloat(e.suLitre || 0));
                 createChart('waterIntakeChart', 'bar', labels, waterData, 'Su TÃ¼ketimi (Litre)', 'rgba(59, 130, 246, 0.7)', 'rgba(59, 130, 246, 1)'); 
            }
        }
        
        function createChart(canvasId, type, labels, data, label, bgColor, borderColor) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Chart canvas with id ${canvasId} not found.`);
                return;
            }
            const ctx = canvas.getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: bgColor,
                        borderColor: borderColor,
                        borderWidth: 2,
                        tension: 0.1, 
                        fill: type === 'line' ? {target: 'origin', above: bgColor.replace('0.7', '0.3')} : false, 
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: type === 'bar', 
                            ticks: { color: '#4B5563' }, 
                            grid: { color: '#E5E7EB' } 
                        },
                        x: {
                            ticks: { color: '#4B5563' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#374151' } 
                        },
                        tooltip: {
                            backgroundColor: '#1F2937', 
                            titleColor: '#F9FAFB', 
                            bodyColor: '#F3F4F6', 
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(1); 
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- NAVIGATION ---
        function setActiveNav(activeButton) {
            [navDailyEntry, navPastEntries, navProgressCharts].forEach(button => {
                if(button) { // ButonlarÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
                    button.classList.remove('active', 'bg-indigo-500', 'text-white');
                    button.classList.add('text-slate-700');
                }
            });
            if(activeButton) { // Aktif butonun varlÄ±ÄŸÄ±nÄ± kontrol et
                activeButton.classList.add('active', 'bg-indigo-500', 'text-white');
                activeButton.classList.remove('text-slate-700');
            }
        }

        if(navDailyEntry) navDailyEntry.addEventListener('click', renderDailyEntry);
        if(navPastEntries) navPastEntries.addEventListener('click', renderPastEntries);
        if(navProgressCharts) navProgressCharts.addEventListener('click', renderProgressCharts);

        // --- INITIALIZATION ---
        function initApp() {
            // DOM elementlerinin varlÄ±ÄŸÄ±nÄ± kontrol et
            const currentYearEl = document.getElementById('currentYear');
            const motivationQuoteElLocal = document.getElementById('motivationQuote'); // Yerel deÄŸiÅŸken, global ile karÄ±ÅŸmasÄ±n diye

            if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();
            if(motivationQuoteElLocal && motivationQuotes.length > 0) {
                const randomIndex = Math.floor(Math.random() * motivationQuotes.length);
                motivationQuoteElLocal.textContent = motivationQuotes[randomIndex];
            }
            renderDailyEntry(); 
        }

        initApp();
    </script>
</body>
</html>